import os
import streamlit as st
import pandas as pd
import numpy as np
import gspread
from google.oauth2.service_account import Credentials
from gspread_dataframe import set_with_dataframe
from dotenv import load_dotenv
from geopy.geocoders import Nominatim
import folium
from streamlit_folium import folium_static
import json
from layer import add_brand_layers

SP_SHEET     = 'tech0_01' 

if 'show_all' not in st.session_state:
    st.session_state['show_all'] = False  

def toggle_show_all():
    st.session_state['show_all'] = not st.session_state['show_all']


def load_data_from_spreadsheet():
    scopes = [
        'https://www.googleapis.com/auth/spreadsheets',
        'https://www.googleapis.com/auth/drive'
    ]

    google_credentials = {
        "type": st.secrets["GOOGLE_CREDENTIALS"]["type"],
        "project_id": st.secrets["GOOGLE_CREDENTIALS"]["project_id"],
        "private_key_id": st.secrets["GOOGLE_CREDENTIALS"]["private_key_id"],
        "private_key": st.secrets["GOOGLE_CREDENTIALS"]["private_key"],
        "client_email": st.secrets["GOOGLE_CREDENTIALS"]["client_email"],
        "client_id": st.secrets["GOOGLE_CREDENTIALS"]["client_id"],
        "auth_uri": st.secrets["GOOGLE_CREDENTIALS"]["auth_uri"],
        "token_uri": st.secrets["GOOGLE_CREDENTIALS"]["token_uri"],
        "auth_provider_x509_cert_url": st.secrets["GOOGLE_CREDENTIALS"]["auth_provider_x509_cert_url"],
        "client_x509_cert_url": st.secrets["GOOGLE_CREDENTIALS"]["client_x509_cert_url"]
    }

    credentials = Credentials.from_service_account_info(
        google_credentials,
        scopes=scopes
    )
    gc = gspread.authorize(credentials)

    SP_SHEET_KEY = st.secrets["SP_SHEET_KEY"] 
    sh  = gc.open_by_key(SP_SHEET_KEY)

    worksheet = sh.worksheet(SP_SHEET) 
    pre_data  = worksheet.get_all_values()
    col_name = pre_data[0][:]
    df = pd.DataFrame(pre_data[1:], columns=col_name) 

    return df

st.title("あなたの《あこがれ》から検索")
#あなたの望みをかなえます。
#東京の象徴的な場所ともいえる千代田区、中央区、港区の「都心3区」をはじめとして、
#通勤に優れ、かつ居住性を合わせ持つ山手線の内側の地域、
#渋谷区、新宿区、品川区、目黒区、豊島区、文京区といったブランドエリアに住んでみませんか？

#簡単です。
#あなたが実現したい夢を、チェックするだけです。

# ブランドエリアのデータ
brand_areas = pd.DataFrame({
    'brand': ['高級で洗練された街並みのエリア', '都会の隠れ家的なエリア', '森林や公園に囲まれた閑静なエリア', '最も治安の良いエリア', '専業主婦が楽しく過ごせるエリア', '文教地区（有力な公立小学校）']
})

# 要注意情報を含むエリアのデータ
negative_areas = {
    '治安の悪いスポットエリア': [
        # 地名: 新宿区歌舞伎町
        {'latitude': 35.694039, 'longitude': 139.702290, 'radius': 500},
        # 地名: 新宿駅周辺
        {'latitude': 35.689616, 'longitude': 139.700410, 'radius': 400},
        # 地名: 渋谷センター街
        {'latitude': 35.660388, 'longitude': 139.699314, 'radius': 300},
        # 地名: 神宮前1丁目
        {'latitude': 35.670264, 'longitude': 139.702137, 'radius': 300},
        # 地名: 池袋西口
        {'latitude': 35.731217, 'longitude': 139.707812, 'radius': 400},
        # 地名: 巣鴨
        {'latitude': 35.733018, 'longitude': 139.739871, 'radius': 300},
        # 地名: 大塚
        {'latitude': 35.731371, 'longitude': 139.728272, 'radius': 300},
        # 地名: 上野駅周辺
        {'latitude': 35.710063, 'longitude': 139.775326, 'radius': 500},
        # 地名: 神田駅周辺
        {'latitude': 35.693840, 'longitude': 139.770950, 'radius': 300},
        # 地名: 秋葉原
        {'latitude': 35.698683, 'longitude': 139.773189, 'radius': 300},
        # 地名: 八丁堀
        {'latitude': 35.677168, 'longitude': 139.777788, 'radius': 300},
        # 地名: 八重洲1丁目
        {'latitude': 35.678380, 'longitude': 139.771775, 'radius': 300},
        # 地名: 六本木
        {'latitude': 35.662830, 'longitude': 139.731749, 'radius': 400},
        # 地名: 麻布十番
        {'latitude': 35.656433, 'longitude': 139.734638, 'radius': 300},
        # 地名: 荏原
        {'latitude': 35.606030, 'longitude': 139.705985, 'radius': 300},
        # 地名: 五反田
        {'latitude': 35.626462, 'longitude': 139.723479, 'radius': 300},
        # 地名: 中目黒
        {'latitude': 35.643969, 'longitude': 139.698190, 'radius': 300},
        # 地名: 自由が丘
        {'latitude': 35.607345, 'longitude': 139.667525, 'radius': 300},
        # 地名: 本郷
        {'latitude': 35.706056, 'longitude': 139.760808, 'radius': 300},
        # 地名: 白山
        {'latitude': 35.722300, 'longitude': 139.747117, 'radius': 300}
    ],
    'ハザードマップの水害危険エリア': [
        # 地名: 港区港南エリア
        {'latitude': 35.643623, 'longitude': 139.745410, 'radius': 500},
        # 地名: 港区芝浦エリア
        {'latitude': 35.643002, 'longitude': 139.750499, 'radius': 400},
        # 地名: 中央区月島エリア
        {'latitude': 35.664167, 'longitude': 139.784162, 'radius': 400},
        # 地名: 中央区勝どきエリア
        {'latitude': 35.659050, 'longitude': 139.777620, 'radius': 400},
        # 地名: 千代田区神田エリア
        {'latitude': 35.693840, 'longitude': 139.770950, 'radius': 300},
        # 地名: 千代田区秋葉原エリア
        {'latitude': 35.698683, 'longitude': 139.773189, 'radius': 300},
        # 地名: 渋谷区恵比寿エリア
        {'latitude': 35.646600, 'longitude': 139.710193, 'radius': 300},
        # 地名: 渋谷区原宿エリア
        {'latitude': 35.669722, 'longitude': 139.702778, 'radius': 300},
        # 地名: 新宿区新宿駅周辺
        {'latitude': 35.689616, 'longitude': 139.700410, 'radius': 400},
        # 地名: 新宿区高田馬場エリア
        {'latitude': 35.712326, 'longitude': 139.703211, 'radius': 300},
        # 地名: 品川区大井町エリア
        {'latitude': 35.609845, 'longitude': 139.734375, 'radius': 300},
        # 地名: 品川区五反田エリア
        {'latitude': 35.626462, 'longitude': 139.723479, 'radius': 300},
        # 地名: 目黒区中目黒エリア
        {'latitude': 35.644043, 'longitude': 139.698353, 'radius': 300},
        # 地名: 目黒区自由が丘エリア
        {'latitude': 35.607345, 'longitude': 139.667525, 'radius': 300},
        # 地名: 豊島区池袋エリア
        {'latitude': 35.731217, 'longitude': 139.707812, 'radius': 400},
        # 地名: 豊島区巣鴨エリア
        {'latitude': 35.733018, 'longitude': 139.739871, 'radius': 300},
        # 地名: 豊島区大塚エリア
        {'latitude': 35.731371, 'longitude': 139.728272, 'radius': 300},
        # 地名: 文京区本郷エリア
        {'latitude': 35.706056, 'longitude': 139.760808, 'radius': 300},
        # 地名: 文京区白山エリア
        {'latitude': 35.722300, 'longitude': 139.747117, 'radius': 300},
        # 地名: 文京区湯島エリア
        {'latitude': 35.707393, 'longitude': 139.770636, 'radius': 300}
    ],
    'ハザードマップの土砂災害危険エリア': [
        # 地名: 港区白金台
        {'latitude': 35.637873, 'longitude': 139.725092, 'radius': 300},
        # 地名: 港区高輪
        {'latitude': 35.640641, 'longitude': 139.738345, 'radius': 300},
        # 地名: 中央区日本橋人形町
        {'latitude': 35.684707, 'longitude': 139.782966, 'radius': 300},
        # 地名: 中央区浜町
        {'latitude': 35.688261, 'longitude': 139.787915, 'radius': 300},
        # 地名: 千代田区九段南
        {'latitude': 35.692203, 'longitude': 139.742539, 'radius': 300},
        # 地名: 千代田区一番町
        {'latitude': 35.684722, 'longitude': 139.742222, 'radius': 300},
        # 地名: 渋谷区代々木
        {'latitude': 35.685175, 'longitude': 139.702042, 'radius': 300},
        # 地名: 渋谷区広尾
        {'latitude': 35.652832, 'longitude': 139.722888, 'radius': 300},
        # 地名: 新宿区神楽坂
        {'latitude': 35.700603, 'longitude': 139.734700, 'radius': 300},
        # 地名: 新宿区四谷
        {'latitude': 35.687611, 'longitude': 139.730123, 'radius': 300},
        # 地名: 品川区北品川
        {'latitude': 35.625226, 'longitude': 139.739417, 'radius': 300},
        # 地名: 品川区南大井
        {'latitude': 35.599830, 'longitude': 139.738743, 'radius': 300},
        # 地名: 目黒区駒場
        {'latitude': 35.659122, 'longitude': 139.684622, 'radius': 300},
        # 地名: 目黒区大橋
        {'latitude': 35.651185, 'longitude': 139.693333, 'radius': 300},
        # 地名: 豊島区目白
        {'latitude': 35.719039, 'longitude': 139.706056, 'radius': 300},
        # 地名: 豊島区高田
        {'latitude': 35.710525, 'longitude': 139.704987, 'radius': 300},
        # 地名: 文京区小石川
        {'latitude': 35.707276, 'longitude': 139.746531, 'radius': 300},
        # 地名: 文京区本駒込
        {'latitude': 35.727675, 'longitude': 139.748690, 'radius': 300},
        # 地名: 文京区白山
        {'latitude': 35.718985, 'longitude': 139.751275, 'radius': 300},
        # 地名: 文京区湯島
        {'latitude': 35.707393, 'longitude': 139.770636, 'radius': 300}
    ],
    '地震危険エリア（火災・倒壊）': [
        # 地名: 港区虎ノ門
        {'latitude': 35.669817, 'longitude': 139.743494, 'radius': 300},
        # 地名: 港区六本木
        {'latitude': 35.662830, 'longitude': 139.731749, 'radius': 300},
        # 地名: 中央区日本橋
        {'latitude': 35.684392, 'longitude': 139.774113, 'radius': 300},
        # 地名: 中央区茅場町
        {'latitude': 35.678050, 'longitude': 139.781200, 'radius': 300},
        # 地名: 千代田区神田
        {'latitude': 35.693840, 'longitude': 139.770950, 'radius': 300},
        # 地名: 千代田区秋葉原
        {'latitude': 35.698683, 'longitude': 139.773189, 'radius': 300},
        # 地名: 渋谷区恵比寿
        {'latitude': 35.646600, 'longitude': 139.710193, 'radius': 300},
        # 地名: 渋谷区広尾
        {'latitude': 35.652832, 'longitude': 139.722888, 'radius': 300},
        # 地名: 新宿区歌舞伎町
        {'latitude': 35.694039, 'longitude': 139.702290, 'radius': 300},
        # 地名: 新宿区新宿三丁目
        {'latitude': 35.691610, 'longitude': 139.706390, 'radius': 300},
        # 地名: 品川区大井町
        {'latitude': 35.606126, 'longitude': 139.734634, 'radius': 300},
        # 地名: 品川区五反田
        {'latitude': 35.626462, 'longitude': 139.723479, 'radius': 300},
        # 地名: 目黒区中目黒
        {'latitude': 35.644043, 'longitude': 139.698353, 'radius': 300},
        # 地名: 目黒区駒場
        {'latitude': 35.661329, 'longitude': 139.683859, 'radius': 300},
        # 地名: 豊島区池袋
        {'latitude': 35.730721, 'longitude': 139.711014, 'radius': 300},
        # 地名: 豊島区巣鴨
        {'latitude': 35.733018, 'longitude': 139.739871, 'radius': 300},
        # 地名: 文京区小石川
        {'latitude': 35.707276, 'longitude': 139.746531, 'radius': 300},
        # 地名: 文京区湯島
        {'latitude': 35.707393, 'longitude': 139.770636, 'radius': 300},
        # 地名: 文京区千駄木
        {'latitude': 35.724671, 'longitude': 139.762935, 'radius': 300},
        # 地名: 文京区本駒込
        {'latitude': 35.727675, 'longitude': 139.748690, 'radius': 300}
    ]
}

# ブランドエリアのポリゴンデータ
polygons = {
    '高級で洗練された街並みのエリア': [
        # 港区麻布十番一丁目
        [(35.6555, 139.7370), (35.6563, 139.7371), (35.6576, 139.7364), (35.6574, 139.7358), (35.6576, 139.7356), (35.6576, 139.7354), (35.6571, 139.7352), (35.6573, 139.7338), (35.6571, 139.7336), (35.6579, 139.7326), (35.6577, 139.7321), (35.6573, 139.7324), (35.6566, 139.7332), (35.6557, 139.7356), (35.6555, 139.7370)],
        # 港区赤坂一丁目
        [(35.6704, 139.7458), (35.6705, 139.7447), (35.6710, 139.7449), (35.6713, 139.7431), (35.6678, 139.7398), (35.6677, 139.7400), (35.6668, 139.7393), (35.6664, 139.7403), (35.6668, 139.7406), (35.6663, 139.7417), (35.6659, 139.7414), (35.6655, 139.7422), (35.6687, 139.7442), (35.6691, 139.7439), (35.6704, 139.7458)],
        # 港区南青山一丁目～七丁目
        [(35.6732, 139.7256), (35.6667, 139.7275), (35.6665, 139.7245), (35.6653, 139.7248), (35.6622, 139.7236), (35.6618, 139.7221), (35.6625, 139.7211), (35.6644, 139.7204), (35.6642, 139.7195), (35.6635, 139.7201), (35.6626, 139.7200), (35.6620, 139.7200), (35.6619, 139.7189), (35.6620, 139.7182), (35.6608, 139.7173), (35.6604, 139.7189), (35.6596, 139.7185), (35.6595, 139.7192), (35.6564, 139.7179), (35.6573, 139.7144), (35.6587, 139.7125), (35.6588, 139.7134), (35.6610, 139.7148), (35.6632, 139.7105), (35.6701, 139.7167), (35.6732, 139.7256)],
        # 渋谷区広尾一丁目
        [(35.6488, 139.7174), (35.6478, 139.7176), (35.6478, 139.7146), (35.6481, 139.7110), (35.6485, 139.7106), (35.6490, 139.7115), (35.6514, 139.7128), (35.6494, 139.7147), (35.6499, 139.7173), (35.6488, 139.7174)],
        # 渋谷区代官山
        [(35.6523, 139.7065), (35.6535, 139.7054), (35.6513, 139.7039), (35.6502, 139.7027), (35.6485, 139.7019), (35.6480, 139.7019), (35.6479, 139.7029), (35.6485, 139.7033), (35.6489, 139.7044), (35.6523, 139.7065)],
        # 新宿区四谷三丁目
        [(35.6873, 139.7190), (35.6871, 139.7189), (35.6871, 139.7179), (35.6885, 139.7178), (35.6885, 139.7186), (35.6882, 139.7186), (35.6885, 139.7219), (35.6884, 139.7235), (35.6878, 139.7232), (35.6879, 139.7230), (35.6875, 139.7229), (35.6876, 139.7219), (35.6875, 139.7219), (35.6876, 139.7210), (35.6873, 139.7190)],
        # 目黒区自由が丘一丁目
        [(35.6131, 139.6720), (35.6138, 139.6687), (35.6066, 139.6681), (35.6065, 139.6685), (35.6076, 139.6712), (35.6122, 139.6714), (35.6131, 139.6720)],
        # 目黒区中目黒一丁目
        [(35.6465, 139.7025), (35.6462, 139.7025), (35.6444, 139.7052), (35.6439, 139.7050), (35.6439, 139.7046), (35.6437, 139.7045), (35.6437, 139.7041), (35.6431, 139.7038), (35.6423, 139.7027), (35.6418, 139.7015), (35.6427, 139.7006), (35.6446, 139.7014), (35.6462, 139.7015), (35.6465, 139.7021), (35.6465, 139.7025)],
        # 品川区高輪三丁目
        [(35.6337, 139.7394), (35.6289, 139.7381), (35.6275, 139.7378), (35.6276, 139.7375), (35.6291, 139.7373), (35.6296, 139.7323), (35.6302, 139.7323), (35.6301, 139.7309), (35.6313, 139.7296), (35.6323, 139.7309), (35.6359, 139.7314), (35.6356, 139.7332), (35.6352, 139.7347), (35.6343, 139.7367), (35.6337, 139.7394)],
        # 文京区本郷三丁目
        [(35.7016, 139.7625), (35.7033, 139.7637), (35.7044, 139.7643), (35.7074, 139.7650), (35.7075, 139.7605), (35.7055, 139.7608), (35.7043, 139.7618), (35.7018, 139.7620), (35.7016, 139.7625)],
        # 千代田区麹町一丁目
        [(35.6840, 139.7446), (35.6853, 139.7449), (35.6854, 139.7429), (35.6856, 139.7430), (35.6857, 139.7416), (35.6844, 139.7415), (35.6834, 139.7417), (35.6832, 139.7441), (35.6839, 139.7442), (35.6840, 139.7446)]
    ],
    '都会の隠れ家的なエリア': [
        # 文京区根津一丁目～二丁目
        [(35.7206, 139.7601), (35.7192, 139.7607), (35.7181, 139.7626), (35.7181, 139.7639), (35.7173, 139.7645), (35.7176, 139.7649), (35.7165, 139.766), (35.7168, 139.7669), (35.7157, 139.7678), (35.7158, 139.7689), (35.7174, 139.7679), (35.7214, 139.7637), (35.7206, 139.7601)],
        # 文京区千駄木一丁目～五丁目
        [(35.6985, 139.7412), (35.7004, 139.7427), (35.7005, 139.7425), (35.7013, 139.7432), (35.7032, 139.7392), (35.7025, 139.7384), (35.7028, 139.7382), (35.7033, 139.7383), (35.7039, 139.7367), (35.7043, 139.7353), (35.7031, 139.7348), (35.7030, 139.7357), (35.7027, 139.7361), (35.7026, 139.7361), (35.7024, 139.7364), (35.7019, 139.7358), (35.7016, 139.7363), (35.7023, 139.7371), (35.7016, 139.7387), (35.7011, 139.7387), (35.7007, 139.7393), (35.7002, 139.7398), (35.7005, 139.7405), (35.6993, 139.7410), (35.6988, 139.7405), (35.6985, 139.7412)],
        # 新宿区神楽坂一丁目～六丁目
        [(35.7043, 139.7353), (35.7049, 139.7354), (35.7053, 139.7324), (35.7043, 139.7322), (35.7048, 139.7306), (35.7043, 139.7283), (35.7024, 139.7280), (35.7019, 139.7296), (35.7010, 139.7295), (35.7010, 139.7307), (35.6999, 139.7309), (35.7014, 139.7348), (35.7017, 139.7342), (35.7043, 139.7353)],
        # 新宿区矢来町
        [(35.7025, 139.7406), (35.7034, 139.7411), (35.7033, 139.7400), (35.7040, 139.7400), (35.7042, 139.7390), (35.7052, 139.7393), (35.7053, 139.7385), (35.7044, 139.7381), (35.7047, 139.7374), (35.7039, 139.7366), (35.7032, 139.7383), (35.7028, 139.7382), (35.7025, 139.7384), (35.7032, 139.7391), (35.7025, 139.7406)],
        # 新宿区白銀町
        [(35.7320, 139.7617), (35.7312, 139.7603), (35.7322, 139.7585), (35.7264, 139.7556), (35.7223, 139.7583), (35.7206, 139.7584), (35.7206, 139.7601), (35.7215, 139.7637), (35.7276, 139.7648), (35.7304, 139.7633), (35.7320, 139.7617)],
        # 渋谷区上原一丁目～三丁目
        [(35.6693, 139.6878), (35.6700, 139.6832), (35.6699, 139.6817), (35.6660, 139.6737), (35.6640, 139.6750), (35.6640, 139.6792), (35.6630, 139.6827), (35.6666, 139.6845), (35.6671, 139.6846), (35.6679, 139.6859), (35.6678, 139.6878), (35.6693, 139.6878)],
        # 渋谷区西原一丁目～三丁目
        [(35.6701, 139.6834), (35.6706, 139.6835), (35.6723, 139.6828), (35.6730, 139.6842), (35.6745, 139.6853), (35.6750, 139.6843), (35.6785, 139.6814), (35.6777, 139.6791), (35.6754, 139.6756), (35.6723, 139.6728), (35.6698, 139.6784), (35.6688, 139.6794), (35.6699, 139.6817), (35.6701, 139.6834)],
        # 目黒区中目黒一丁目～五丁目
        [(35.6466, 139.7024), (35.6461, 139.7015), (35.6418, 139.7003), (35.6410, 139.6991), (35.6382, 139.6975), (35.6356, 139.6931), (35.6351, 139.6961), (35.6353, 139.6978), (35.6335, 139.6982), (35.6350, 139.7011), (35.6352, 139.7018), (35.6351, 139.7031), (35.6355, 139.7037), (35.6355, 139.7043), (35.6359, 139.7052), (35.6358, 139.7058), (35.6361, 139.7061), (35.6374, 139.7051), (35.6391, 139.7076), (35.6416, 139.7103), (35.6421, 139.7088), (35.6466, 139.7024)],
        # 目黒区青葉台一丁目～四丁目
        [(35.6571, 139.6911), (35.6539, 139.6895), (35.6510, 139.6898), (35.6492, 139.6916), (35.6457, 139.6974), (35.6473, 139.6985), (35.6471, 139.6992), (35.6473, 139.7001), (35.6470, 139.7012), (35.6472, 139.7013), (35.6486, 139.6989), (35.6488, 139.6993), (35.6540, 139.6933), (35.6571, 139.6911)],
        # 目黒区上目黒一丁目～五丁目
        [(35.6466, 139.7024), (35.6470, 139.7012), (35.6474, 139.7001), (35.6471, 139.6992), (35.6473, 139.6985), (35.6457, 139.6973), (35.6461, 139.6953), (35.6461, 139.6943), (35.6458, 139.6933), (35.6443, 139.6918), (35.6442, 139.6901), (35.6459, 139.6881), (35.6447, 139.6873), (35.6448, 139.6871), (35.6429, 139.6859), (35.6428, 139.6845), (35.6407, 139.6858), (35.6398, 139.6859), (35.6404, 139.6867), (35.6397, 139.6877), (35.6402, 139.6894), (35.6398, 139.6897), (35.6392, 139.6924), (35.6410, 139.6943), (35.6390, 139.6958), (35.6382, 139.6975), (35.6410, 139.6991), (35.6419, 139.7003), (35.6460, 139.7014), (35.6466, 139.7024)]
    ],
    '森林や公園に囲まれた閑静なエリア': [
        # 渋谷区代々木一丁目～五丁目
        [(35.6892, 139.7005), (35.6870, 139.6948), (35.6824, 139.6880), (35.6816, 139.6888), (35.6770, 139.6879), (35.6694, 139.6879), (35.6704, 139.6901), (35.6704, 139.6908), (35.6744, 139.6915), (35.6795, 139.6945), (35.6802, 139.6960), (35.6815, 139.6982), (35.6787, 139.7040), (35.6892, 139.7005)],
        # 港区広尾一丁目～五丁目
        [(35.6564, 139.7230), (35.6557, 139.7221), (35.6570, 139.7182), (35.6564, 139.7179), (35.6572, 139.7144), (35.6560, 139.7138), (35.6523, 139.7133), (35.6490, 139.7113), (35.6486, 139.7127), (35.6482, 139.7146), (35.6489, 139.7188), (35.6477, 139.7228), (35.6507, 139.7223), (35.6525, 139.7221), (35.6538, 139.7217), (35.6564, 139.7230)],
        # 港区南麻布五丁目
        [(35.6560, 139.7228), (35.6552, 139.7250), (35.6522, 139.7292), (35.6514, 139.7277), (35.6510, 139.7256), (35.6514, 139.7238), (35.6511, 139.7236), (35.6508, 139.7223), (35.6524, 139.7221), (35.6538, 139.7216), (35.6560, 139.7228)],
        # 港区白金台一丁目～五丁目
        [(35.6403, 139.7329), (35.6401, 139.7303), (35.6391, 139.7283), (35.6394, 139.7282), (35.6401, 139.7283), (35.6410, 139.7244), (35.6413, 139.7244), (35.6416, 139.7233), (35.6416, 139.7223), (35.6432, 139.7209), (35.6420, 139.7197), (35.6405, 139.7174), (35.6400, 139.7171), (35.6381, 139.7169), (35.6378, 139.7175), (35.6359, 139.7179), (35.6356, 139.7173), (35.6349, 139.7179), (35.6354, 139.7197), (35.6345, 139.7199), (35.6358, 139.7225), (35.6349, 139.7263), (35.6341, 139.7268), (35.6328, 139.7263), (35.6326, 139.7267), (35.6321, 139.7268), (35.6318, 139.7277), (35.6329, 139.7282), (35.6326, 139.7289), (35.6318, 139.7287), (35.6311, 139.7294), (35.6323, 139.7309), (35.6388, 139.7318), (35.6403, 139.7329)],
        # 港区白金五丁目
        [(35.6440, 139.7277), (35.6443, 139.7268), (35.6447, 139.7226), (35.6455, 139.7227), (35.6470, 139.7238), (35.6467, 139.7246), (35.6465, 139.7280), (35.6459, 139.7281), (35.6440, 139.7277)],
        # 六本木四丁目
        [(35.6654, 139.7365), (35.6658, 139.7361), (35.6656, 139.7357), (35.6670, 139.7351), (35.6669, 139.7347), (35.6665, 139.7342), (35.6670, 139.7336), (35.6653, 139.7324), (35.6650, 139.7315), (35.6644, 139.7311), (35.6632, 139.7323), (35.6654, 139.7365)],
        # 目黒区目黒一丁目～四丁目
        [(35.6384, 139.7131), (35.6377, 139.7136), (35.6375, 139.7131), (35.6338, 139.7145), (35.6343, 139.7132), (35.6345, 139.7122), (35.6319, 139.7067), (35.6305, 139.7013), (35.6337, 139.6986), (35.6351, 139.7013), (35.6352, 139.7018), (35.6350, 139.7030), (35.6355, 139.7036), (35.6354, 139.7043), (35.6360, 139.7052), (35.6357, 139.7058), (35.6360, 139.7062), (35.6374, 139.7051), (35.6381, 139.7061), (35.6366, 139.7077), (35.6379, 139.7091), (35.6376, 139.7105), (35.6378, 139.7106), (35.6375, 139.7114), (35.6384, 139.7131)],
        # 目黒区下目黒六丁目
        [(35.6304, 139.7012), (35.6293, 139.7007), (35.6265, 139.7015), (35.6262, 139.7018), (35.6260, 139.7017), (35.6261, 139.7005), (35.6257, 139.6989), (35.6270, 139.6978), (35.6282, 139.6963), (35.6285, 139.6962), (35.6284, 139.6954), (35.6287, 139.6953), (35.6304, 139.7012)],
        # 文京区小石川一丁目～五丁目
        [(35.7154, 139.7519), (35.7150, 139.7482), (35.7169, 139.7456), (35.7175, 139.7442), (35.7208, 139.7402), (35.7186, 139.7372), (35.7189, 139.7366), (35.7183, 139.7360), (35.7157, 139.7397), (35.7140, 139.7409), (35.7106, 139.7462), (35.7085, 139.7499), (35.7085, 139.7536), (35.7154, 139.7519)],
        # 文京区後楽一丁目
        [(35.7025, 139.7553), (35.7056, 139.7544), (35.7070, 139.7518), (35.7067, 139.7465), (35.7033, 139.7462), (35.7025, 139.7553)],
        # 港区高輪一丁目～四丁目
        [(35.6402, 139.7411), (35.6400, 139.7387), (35.6454, 139.7357), (35.6404, 139.7328), (35.6388, 139.7318), (35.6323, 139.7309), (35.6311, 139.7294), (35.6312, 139.7297), (35.6300, 139.7312), (35.6288, 139.7311), (35.6263, 139.7312), (35.6260, 139.7339), (35.6231, 139.7352), (35.6234, 139.7376), (35.6252, 139.7382), (35.6268, 139.7377), (35.6268, 139.7382), (35.6303, 139.7385), (35.6387, 139.7419), (35.6394, 139.7410), (35.6402, 139.7411)]
    ],
    '最も治安の良いエリア': [
        # 文京区本郷一丁目～七丁目
        [(35.7112, 139.7529), (35.7025, 139.7553), (35.7019, 139.7576), (35.7018, 139.7620), (35.7016, 139.7626), (35.7043, 139.7643), (35.7074, 139.7651), (35.7075, 139.7637), (35.7087, 139.7637), (35.7087, 139.7642), (35.7100, 139.7643), (35.7099, 139.7653), (35.7105, 139.7653), (35.7105, 139.7664), (35.7113, 139.7669), (35.7114, 139.7676), (35.7129, 139.7677), (35.7136, 139.7654), (35.7157, 139.7616), (35.7153, 139.7584), (35.7146, 139.7573), (35.7137, 139.7571), (35.7114, 139.7550), (35.7112, 139.7529)],
        # 文京区小石川一丁目～五丁目
        [(35.7154, 139.7519), (35.7150, 139.7482), (35.7169, 139.7456), (35.7175, 139.7442), (35.7208, 139.7402), (35.7186, 139.7372), (35.7189, 139.7366), (35.7183, 139.7360), (35.7157, 139.7397), (35.7140, 139.7409), (35.7106, 139.7462), (35.7085, 139.7499), (35.7085, 139.7536), (35.7154, 139.7519)],
        # 文京区後楽一丁目～二丁目
        [(35.7056, 139.7544), (35.7070, 139.7518), (35.7068, 139.7465), (35.7080, 139.7451), (35.7077, 139.7433), (35.7028, 139.7449), (35.7033, 139.7468), (35.7025, 139.7553), (35.7056, 139.7544)],
        # 文京区目白台一丁目～三丁目
        [(35.7201, 139.7243), (35.7197, 139.7229), (35.7188, 139.7226), (35.7185, 139.7218), (35.7186, 139.7215), (35.7182, 139.7197), (35.7175, 139.7193), (35.7180, 139.7182), (35.7174, 139.7175), (35.7170, 139.7179), (35.7145, 139.7171), (35.7143, 139.7177), (35.7142, 139.7186), (35.7137, 139.7203), (35.7121, 139.7227), (35.7120, 139.7233), (35.7147, 139.7250), (35.7152, 139.7247), (35.7154, 139.7249), (35.7152, 139.7270), (35.7154, 139.7284), (35.7190, 139.7266), (35.7195, 139.7249), (35.7201, 139.7243)],
        # 港区白金台一丁目～五丁目
        [(35.6403, 139.7329), (35.6401, 139.7303), (35.6391, 139.7283), (35.6394, 139.7282), (35.6401, 139.7283), (35.6410, 139.7244), (35.6413, 139.7244), (35.6416, 139.7233), (35.6416, 139.7223), (35.6432, 139.7209), (35.6420, 139.7197), (35.6405, 139.7174), (35.6400, 139.7171), (35.6381, 139.7169), (35.6378, 139.7175), (35.6359, 139.7179), (35.6356, 139.7173), (35.6349, 139.7179), (35.6354, 139.7197), (35.6345, 139.7199), (35.6358, 139.7225), (35.6349, 139.7263), (35.6341, 139.7268), (35.6328, 139.7263), (35.6326, 139.7267), (35.6321, 139.7268), (35.6318, 139.7277), (35.6329, 139.7282), (35.6326, 139.7289), (35.6318, 139.7287), (35.6311, 139.7294), (35.6323, 139.7309), (35.6388, 139.7318), (35.6403, 139.7329)],
        # 港区麻布十番一丁目～四丁目
        [(35.6581, 139.7362), (35.6580, 139.7353), (35.6585, 139.7350), (35.6584, 139.7347), (35.6573, 139.7348), (35.6575, 139.7338), (35.6571, 139.7336), (35.6577, 139.7328), (35.6584, 139.7325), (35.6582, 139.7319), (35.6571, 139.7325), (35.6566, 139.7333), (35.6562, 139.7328), (35.6559, 139.7333), (35.6556, 139.7331), (35.6555, 139.7332), (35.6553, 139.7333), (35.6554, 139.7337), (35.6552, 139.7348), (35.6526, 139.7343), (35.6526, 139.7367), (35.6538, 139.7375), (35.6555, 139.7376), (35.6554, 139.7370), (35.6568, 139.7371), (35.6581, 139.7362)],
        # 千代田区麹町一丁目～六丁目
        [(35.6839, 139.7447), (35.6852, 139.7449), (35.6853, 139.7429), (35.6856, 139.7429), (35.6858, 139.7392), (35.6859, 139.7391), (35.6850, 139.7380), (35.6844, 139.7352), (35.6849, 139.7350), (35.6848, 139.7345), (35.6852, 139.7338), (35.6855, 139.7346), (35.6865, 139.7341), (35.6856, 139.7326), (35.6863, 139.7319), (35.6860, 139.7316), (35.6864, 139.7305), (35.6849, 139.7301), (35.6848, 139.7303), (35.6846, 139.7302), (35.6847, 139.7300), (35.6836, 139.7305), (35.6844, 139.7331), (35.6830, 139.7336), (35.6822, 139.7347), (35.6825, 139.7358), (35.6830, 139.7365), (35.6830, 139.7382), (35.6834, 139.7416), (35.6831, 139.7441), (35.6840, 139.7441), (35.6839, 139.7447)],
        # 千代田区永田町一丁目～二丁目
        [(35.6799, 139.7458), (35.6784, 139.7364), (35.6742, 139.7388), (35.6713, 139.7432), (35.6720, 139.7444), (35.6724, 139.7464), (35.6771, 139.7498), (35.6794, 139.7472), (35.6799, 139.7458)],
        # 千代田区一番町
        [(35.6852, 139.7449), (35.6882, 139.7455), (35.6882, 139.7452), (35.6891, 139.7454), (35.6882, 139.7422), (35.6895, 139.7428), (35.6879, 139.7377), (35.6857, 139.7392), (35.6856, 139.7429), (35.6853, 139.7430), (35.6852, 139.7449)],
        # 中央区日本橋一丁目～三丁目
        [(35.6779, 139.7748), (35.6842, 139.7786), (35.6845, 139.7778), (35.6840, 139.7743), (35.6842, 139.7730), (35.6798, 139.7703), (35.6779, 139.7748)],
        # 中央区銀座一丁目～八丁目
        [(35.6737, 139.7728), (35.6712, 139.7719), (35.6676, 139.7677), (35.6667, 139.7677), (35.6636, 139.7640), (35.6638, 139.7631), (35.6648, 139.7633), (35.6670, 139.7624), (35.6684, 139.7585), (35.6726, 139.7606), (35.6734, 139.7641), (35.6759, 139.7659), (35.6754, 139.7676), (35.6754, 139.7691), (35.6737, 139.7728)],
        # 中央区京橋一丁目～三丁目
        [(35.6784, 139.7738), (35.6797, 139.7703), (35.6754, 139.7676), (35.6754, 139.7691), (35.6737, 139.7728), (35.6745, 139.7726), (35.6779, 139.7748), (35.6784, 139.7738)],
        # 渋谷区広尾一丁目～五丁目
        [(35.6564, 139.7230), (35.6557, 139.7221), (35.6570, 139.7182), (35.6564, 139.7179), (35.6572, 139.7144), (35.6560, 139.7138), (35.6523, 139.7133), (35.6490, 139.7113), (35.6486, 139.7127), (35.6482, 139.7146), (35.6489, 139.7188), (35.6477, 139.7228), (35.6507, 139.7223), (35.6525, 139.7221), (35.6538, 139.7217), (35.6564, 139.7230)],
        # 渋谷区上原一丁目～三丁目
        [(35.6693, 139.6878), (35.6700, 139.6832), (35.6699, 139.6817), (35.6660, 139.6737), (35.6640, 139.6750), (35.6640, 139.6792), (35.6630, 139.6827), (35.6666, 139.6845), (35.6671, 139.6846), (35.6679, 139.6859), (35.6678, 139.6878), (35.6693, 139.6878)],
        # 新宿区四谷一丁目～四丁目
        [(35.6846, 139.7300), (35.6810, 139.7317), (35.6807, 139.7312), (35.6824, 139.7299), (35.6827, 139.7278), (35.6840, 139.7281), (35.6842, 139.7272), (35.6853, 139.7274), (35.6855, 139.7269), (35.6862, 139.7270), (35.6864, 139.7260), (35.6858, 139.7258), (35.6865, 139.7243), (35.6870, 139.7245), (35.6876, 139.7220), (35.6874, 139.7219), (35.6872, 139.7182), (35.6861, 139.7182), (35.6861, 139.7175), (35.6870, 139.7175), (35.6870, 139.7170), (35.6872, 139.7170), (35.6871, 139.7159), (35.6875, 139.7159), (35.6880, 139.7140), (35.6908, 139.7149), (35.6911, 139.7147), (35.6907, 139.7161), (35.6910, 139.7166), (35.6909, 139.7172), (35.6910, 139.7175), (35.6901, 139.7177), (35.6902, 139.7182), (35.6898, 139.7182), (35.6898, 139.7188), (35.6891, 139.7185), (35.6891, 139.7181), (35.6886, 139.7180), (35.6888, 139.7225), (35.6875, 139.7269), (35.6885, 139.7275), (35.6882, 139.7284), (35.6874, 139.7280), (35.6867, 139.7296), (35.6872, 139.7297), (35.6870, 139.7301), (35.6882, 139.7306), (35.6880, 139.7311), (35.6846, 139.7300)],
        # 新宿区信濃町
        [(35.6831, 139.7172), (35.6807, 139.7169), (35.6805, 139.7192), (35.6799, 139.7191), (35.6799, 139.7218), (35.6804, 139.7218), (35.6804, 139.7211), (35.6809, 139.7211), (35.6810, 139.7231), (35.6820, 139.7229), (35.6821, 139.7231), (35.6835, 139.7230), (35.6836, 139.7222), (35.6840, 139.7221), (35.6841, 139.7201), (35.6845, 139.7201), (35.6846, 139.7191), (35.6841, 139.7190), (35.6843, 139.7183), (35.6831, 139.7180), (35.6831, 139.7172)]
    ],
    '専業主婦が楽しく過ごせるエリア': [
        # 目黒区自由が丘一丁目～三丁目
        [(35.6140, 139.6674), (35.6131, 139.6720), (35.6122, 139.6714), (35.6075, 139.6712), (35.6065, 139.6684), (35.6067, 139.6669), (35.6088, 139.6626), (35.6099, 139.6627), (35.6097, 139.6639), (35.6101, 139.6640), (35.6113, 139.6634), (35.6122, 139.6635), (35.6121, 139.6627), (35.6125, 139.6629), (35.6130, 139.6635), (35.6129, 139.6624), (35.6139, 139.6624), (35.6140, 139.6674)],
        # 港区麻布十番一丁目～四丁目
        [(35.6581, 139.7362), (35.6580, 139.7353), (35.6585, 139.7350), (35.6584, 139.7347), (35.6573, 139.7348), (35.6575, 139.7338), (35.6571, 139.7336), (35.6577, 139.7328), (35.6584, 139.7325), (35.6582, 139.7319), (35.6571, 139.7325), (35.6566, 139.7333), (35.6562, 139.7328), (35.6559, 139.7333), (35.6556, 139.7331), (35.6555, 139.7332), (35.6553, 139.7333), (35.6554, 139.7337), (35.6552, 139.7348), (35.6526, 139.7343), (35.6526, 139.7367), (35.6538, 139.7375), (35.6555, 139.7376), (35.6554, 139.7370), (35.6568, 139.7371), (35.6581, 139.7362)],
        # 港区広尾一丁目～五丁目
        [(35.6564, 139.7230), (35.6557, 139.7221), (35.6570, 139.7182), (35.6564, 139.7179), (35.6572, 139.7144), (35.6560, 139.7138), (35.6523, 139.7133), (35.6490, 139.7113), (35.6486, 139.7127), (35.6482, 139.7146), (35.6489, 139.7188), (35.6477, 139.7228), (35.6507, 139.7223), (35.6525, 139.7221), (35.6538, 139.7217), (35.6564, 139.7230)],
        # 渋谷区代官山町
        [(35.6523, 139.7065), (35.6535, 139.7054), (35.6513, 139.7039), (35.6502, 139.7027), (35.6485, 139.7019), (35.6480, 139.7019), (35.6479, 139.7029), (35.6485, 139.7033), (35.6489, 139.7044), (35.6523, 139.7065)],
        # 渋谷区恵比寿一丁目～四丁目
        [(35.6416, 139.7191), (35.6428, 139.7205), (35.6452, 139.7227), (35.6467, 139.7234), (35.6473, 139.7227), (35.6478, 139.7176), (35.6478, 139.7144), (35.6481, 139.7110), (35.6485, 139.7105), (35.6478, 139.7093), (35.6422, 139.7125), (35.6426, 139.7152), (35.6417, 139.7168), (35.6416, 139.7191)],
        # 文京区小石川一丁目～五丁目
        [(35.7154, 139.7519), (35.7150, 139.7482), (35.7169, 139.7456), (35.7175, 139.7442), (35.7208, 139.7402), (35.7186, 139.7372), (35.7189, 139.7366), (35.7183, 139.7360), (35.7157, 139.7397), (35.7140, 139.7409), (35.7106, 139.7462), (35.7085, 139.7499), (35.7085, 139.7536), (35.7154, 139.7519)],
        # 文京区後楽一丁目
        [(35.7025, 139.7553), (35.7056, 139.7544), (35.7070, 139.7518), (35.7067, 139.7465), (35.7033, 139.7462), (35.7025, 139.7553)],
        # 中央区銀座一丁目～八丁目
        [(35.6737, 139.7728), (35.6712, 139.7719), (35.6676, 139.7677), (35.6667, 139.7677), (35.6636, 139.7640), (35.6638, 139.7631), (35.6648, 139.7633), (35.6670, 139.7624), (35.6684, 139.7585), (35.6726, 139.7606), (35.6734, 139.7641), (35.6759, 139.7659), (35.6754, 139.7676), (35.6754, 139.7691), (35.6737, 139.7728)],
        # 中央区日本橋一丁目～三丁目
        [(35.6779, 139.7748), (35.6842, 139.7786), (35.6845, 139.7778), (35.6840, 139.7743), (35.6842, 139.7730), (35.6798, 139.7703), (35.6779, 139.7748)]
    ],
    '文教地区（有力な公立小学校）': [
        # 文京区本郷一丁目～七丁目
        [(35.7112, 139.7529), (35.7025, 139.7553), (35.7019, 139.7576), (35.7018, 139.7620), (35.7016, 139.7626), (35.7043, 139.7643), (35.7074, 139.7651), (35.7075, 139.7637), (35.7087, 139.7637), (35.7087, 139.7642), (35.7100, 139.7643), (35.7099, 139.7653), (35.7105, 139.7653), (35.7105, 139.7664), (35.7113, 139.7669), (35.7114, 139.7676), (35.7129, 139.7677), (35.7136, 139.7654), (35.7157, 139.7616), (35.7153, 139.7584), (35.7146, 139.7573), (35.7137, 139.7571), (35.7114, 139.7550), (35.7112, 139.7529)],
        # 文京区根津一丁目～二丁目
        [(35.7206, 139.7601), (35.7192, 139.7607), (35.7181, 139.7626), (35.7181, 139.7639), (35.7173, 139.7645), (35.7176, 139.7649), (35.7165, 139.766), (35.7168, 139.7669), (35.7157, 139.7678), (35.7158, 139.7689), (35.7174, 139.7679), (35.7214, 139.7637), (35.7206, 139.7601)],
        # 港区白金一丁目～六丁目
        [(35.6466, 139.7360), (35.6455, 139.7357), (35.6403, 139.7327), (35.6401, 139.7302), (35.6390, 139.7283), (35.6394, 139.7281), (35.6401, 139.7282), (35.6410, 139.7244), (35.6413, 139.7243), (35.6416, 139.7234), (35.6416, 139.7223), (35.6432, 139.7208), (35.6439, 139.7211), (35.6441, 139.7209), (35.6444, 139.7213), (35.6445, 139.7225), (35.6455, 139.7227), (35.6470, 139.7238), (35.6467, 139.7246), (35.6465, 139.7280), (35.6470, 139.7291), (35.6473, 139.7326), (35.6466, 139.7360)],
        # 港区赤坂一丁目～九丁目
        [(35.6644, 139.7311), (35.6650, 139.7315), (35.6654, 139.7324), (35.6670, 139.7336), (35.6665, 139.7343), (35.6669, 139.7347), (35.6670, 139.7350), (35.6671, 139.7356), (35.6687, 139.7376), (35.6680, 139.7390), (35.6678, 139.7389), (35.6679, 139.7391), (35.6674, 139.7399), (35.6668, 139.7392), (35.6659, 139.7404), (35.6663, 139.7408), (35.6655, 139.7420), (35.6688, 139.7442), (35.6691, 139.7439), (35.6703, 139.7458), (35.6705, 139.7448), (35.6710, 139.7451), (35.6714, 139.7431), (35.6742, 139.7388), (35.6782, 139.7366), (35.6749, 139.7309), (35.6733, 139.7256), (35.6669, 139.7274), (35.6644, 139.7311)],
        # 千代田区麹町一丁目～六丁目
        [(35.6839, 139.7447), (35.6852, 139.7449), (35.6853, 139.7429), (35.6856, 139.7429), (35.6858, 139.7392), (35.6859, 139.7391), (35.6850, 139.7380), (35.6844, 139.7352), (35.6849, 139.7350), (35.6848, 139.7345), (35.6852, 139.7338), (35.6855, 139.7346), (35.6865, 139.7341), (35.6856, 139.7326), (35.6863, 139.7319), (35.6860, 139.7316), (35.6864, 139.7305), (35.6849, 139.7301), (35.6848, 139.7303), (35.6846, 139.7302), (35.6847, 139.7300), (35.6836, 139.7305), (35.6844, 139.7331), (35.6830, 139.7336), (35.6822, 139.7347), (35.6825, 139.7358), (35.6830, 139.7365), (35.6830, 139.7382), (35.6834, 139.7416), (35.6831, 139.7441), (35.6840, 139.7441), (35.6839, 139.7447)],
        # 千代田区九段北一丁目～四丁目
        [(35.6957, 139.7527), (35.6979, 139.7524), (35.6982, 139.7502), (35.6971, 139.7508), (35.6968, 139.7487), (35.6964, 139.7485), (35.6963, 139.7476), (35.6966, 139.7473), (35.6961, 139.7449), (35.6947, 139.7399), (35.6952, 139.7391), (35.6930, 139.7373), (35.6917, 139.7353), (35.6911, 139.7362), (35.6953, 139.7497), (35.6957, 139.7527)],
        # 中央区明石町
        [(35.6688, 139.7805), (35.6704, 139.7746), (35.6696, 139.7752), (35.6670, 139.7742), (35.6662, 139.7774), (35.6654, 139.7765), (35.6648, 139.7775), (35.6664, 139.7792), (35.6688, 139.7805)],
        # 中央区月島一丁目～四丁目
        [(35.6631, 139.7862), (35.6672, 139.7818), (35.6639, 139.7793), (35.6624, 139.7770), (35.6587, 139.7810), (35.6610, 139.7844), (35.6631, 139.7862)]
    ]
}

# 地図の初期設定
map_center = [35.6680, 139.7150]
m = folium.Map(location=map_center, zoom_start=12)

# ブランドエリアの選択
st.sidebar.title("ブランドエリアの選択")
selected_brands = []
for brand in brand_areas['brand']:
    if st.sidebar.checkbox(brand, False):  # デフォルトでオフに設定
        selected_brands.append(brand)

# 要注意情報を含むエリアの選択
st.sidebar.title("要注意情報を含むエリアの選択")
selected_negative_brands = []
for brand in negative_areas.keys(): 
    if st.sidebar.checkbox(brand, False):  # デフォルトでオフに設定
        selected_negative_brands.append(brand)

# 選択されたブランドエリアのみをフィルタリング
selected_brand_areas = brand_areas[brand_areas['brand'].isin(selected_brands)]

# 選択されたポリゴンを取得
selected_polygons = {brand: polygons[brand] for brand in selected_brands}  # ポリゴンを辞書形式で管理

# 選択されたネガティブエリアのみをフィルタリング
selected_negative_areas = {brand: negative_areas[brand] for brand in selected_negative_brands}

# 選択されたブランドエリアとネガティブエリアのレイヤーを追加
m = add_brand_layers(m, selected_brand_areas, selected_polygons, selected_negative_areas)  # ポリゴンを辞書形式で渡す

# 地図を表示
folium_static(m)

st.subheader("地図を拡大しましょう。")
st.subheader("あなたのお気に入りのエリアでしたか？ 条件を加えて、ここで住まいを探しましょう！")

def preprocess_dataframe(df):
    df['家賃'] = pd.to_numeric(df['家賃'], errors='coerce')
    df = df.dropna(subset=['家賃'])
    return df

def make_clickable(url, name):
    return f'<a target="_blank" href="{url}">{name}</a>'

def create_map(filtered_df):
    map_center = [filtered_df['latitude'].mean(), filtered_df['longitude'].mean()]
    m = folium.Map(location=map_center, zoom_start=12)

    for idx, row in filtered_df.iterrows():
        if pd.notnull(row['latitude']) and pd.notnull(row['longitude']):
            popup_html = f"""
            <b>名称:</b> {row['名称']}<br>
            <b>アドレス:</b> {row['アドレス']}<br>
            <b>家賃:</b> {row['家賃']}万円<br>
            <b>間取り:</b> {row['間取り']}<br>
            <a href="{row['物件詳細URL']}" target="_blank">物件詳細</a>
            """
            popup = folium.Popup(popup_html, max_width=400)
            folium.Marker(
                [row['latitude'], row['longitude']],
                popup=popup
            ).add_to(m)

    return m

def display_search_results(filtered_df):
    filtered_df['物件番号'] = range(1, len(filtered_df) + 1)
    filtered_df['物件詳細URL'] = filtered_df['物件詳細URL'].apply(lambda x: make_clickable(x, "リンク"))
    display_columns = ['物件番号', '名称', 'アドレス', '階数', '家賃', '間取り', '物件詳細URL']
    filtered_df_display = filtered_df[display_columns]
    st.markdown(filtered_df_display.to_html(escape=False, index=False), unsafe_allow_html=True)

def main():
    df = load_data_from_spreadsheet()
    df = preprocess_dataframe(df)

    st.title('賃貸物件情報の可視化')

    col1, col2 = st.columns([1, 2])

    with col1:
        area = st.radio('■ エリア選択', df['区'].unique())


    with col2:
        price_min, price_max = st.slider(
            '■ 家賃範囲 (万円)', 
            min_value=float(1), 
            max_value=float(df['家賃'].max()),
            value=(float(df['家賃'].min()), float(df['家賃'].max())),
            step=0.1,  
            format='%.1f'
        )

    with col2:
        type_options = st.multiselect('■ 間取り選択', df['間取り'].unique(), default=df['間取り'].unique())


    filtered_df = df[(df['区'].isin([area])) & (df['間取り'].isin(type_options))]
    filtered_df = filtered_df[(filtered_df['家賃'] >= price_min) & (filtered_df['家賃'] <= price_max)]
    filtered_count = len(filtered_df)

    filtered_df['latitude'] = pd.to_numeric(filtered_df['latitude'], errors='coerce')
    filtered_df['longitude'] = pd.to_numeric(filtered_df['longitude'], errors='coerce')
    filtered_df2 = filtered_df.dropna(subset=['latitude', 'longitude'])


    col2_1, col2_2 = st.columns([1, 2])

    with col2_2:
        st.write(f"物件検索数: {filtered_count}件 / 全{len(df)}件")

    if col2_1.button('検索＆更新', key='search_button'):
        st.session_state['filtered_df'] = filtered_df
        st.session_state['filtered_df2'] = filtered_df2
        st.session_state['search_clicked'] = True

    if st.session_state.get('search_clicked', False):
        m = create_map(st.session_state.get('filtered_df2', filtered_df2))
        folium_static(m)

    show_all_option = st.radio(
        "表示オプションを選択してください:",
        ('地図上の検索物件のみ', 'すべての検索物件'),
        index=0 if not st.session_state.get('show_all', False) else 1,
        key='show_all_option'
    )

    st.session_state['show_all'] = (show_all_option == 'すべての検索物件')

    if st.session_state.get('search_clicked', False):
        if st.session_state['show_all']:
            display_search_results(st.session_state.get('filtered_df', filtered_df))  
        else:
            display_search_results(st.session_state.get('filtered_df2', filtered_df2))  


if __name__ == "__main__":
    if 'search_clicked' not in st.session_state:
        st.session_state['search_clicked'] = False
    if 'show_all' not in st.session_state:
        st.session_state['show_all'] = False
    main()